# 视频字幕和语音合成工具使用说明

## 📖 项目简介

这是一个基于Python 2.7.18和FFmpeg的视频字幕和语音合成工具，支持智能文本分割、多种字幕样式、语音合成和批量处理功能。

## ✨ 主要功能

- **智能字幕生成**: 自动将文案文档转换为SRT格式字幕文件
- **视频字幕嵌入**: 将字幕直接嵌入到视频中生成带字幕的新视频
- **🎙️ 语音合成**: 根据字幕文本自动生成语音音频，与视频音频混合 ⭐ **新功能**
- **批量处理**: 支持连续处理多个文件，提高工作效率
- **多种分割模式**: 智能分割、按秒分割、自动分配时间
- **自定义开始时间**: 可以设置字幕从视频的任意时间点开始
- **多种字幕样式**: 支持不同字体大小的字幕样式
- **多种语音选择**: 支持4种中文语音（男女声可选）
- **文件管理**: 自动管理生成的SRT文件、音频文件和输出视频

## 📁 项目结构

```
FFPR/
├── subtitle_cli.py          # 字幕功能主界面
├── subtitle_generator.py    # 字幕生成引擎
├── subtitle_inserter.py     # 字幕嵌入引擎
├── text_to_speech.py        # 语音合成引擎 ⭐ 新增
├── utils.py                # 工具函数
├── cli.py                  # 主程序入口
├── srt/                    # SRT字幕文件存储目录
├── audio/                  # 音频文件存储目录 ⭐ 新增
├── temp/                   # 临时文件目录
└── 字幕功能使用说明.md      # 本说明文档
```

## 🚀 使用方法

### 方法一：通过字幕专用界面

```bash
python subtitle_cli.py
```

这将启动字幕功能专用界面，提供以下选项：
- **添加字幕到视频**: 生成带字幕的视频文件
- **仅生成SRT文件**: 只生成字幕文件，不处理视频

### 方法二：通过主程序

```bash
python cli.py
```

在主程序菜单中选择字幕相关功能。

## 📝 详细操作步骤

### 1. 添加字幕到视频模式

1. 运行 `python subtitle_cli.py`
2. 选择 `1. 添加字幕到视频`
3. 输入视频文件路径
4. 选择字幕来源：
   - 文案文档 (.txt, .md)
   - 现有字幕文件 (.srt)
   - 手动输入文本
5. 选择分割模式：
   - 智能分割（推荐）
   - 按秒分割
   - 自动模式
6. 设置字幕开始时间（默认0秒）
7. 预览字幕内容并确认
8. 选择字幕样式（默认/大字体/小字体）
9. **🎙️ 语音合成设置**: ⭐ **新功能**
   - 选择是否启用语音合成
   - 选择语音类型（4种中文语音可选）
10. 设置输出文件名
11. 确认开始处理
12. 完成后选择是否继续处理其他视频

### 2. 仅生成SRT文件模式

1. 运行 `python subtitle_cli.py`
2. 选择 `2. 仅生成SRT文件`
3. 选择字幕来源（文案文档/现有SRT/手动输入）
4. 选择分割模式
5. 设置字幕开始时间
6. 预览字幕内容并确认
7. 自动生成SRT文件到srt目录
8. 完成后选择是否继续生成其他SRT文件

## ⚙️ 配置选项详解

### 字幕分割模式

- **智能分割**: 按句子和语义边界分割，每条字幕显示1秒（推荐）
- **按秒分割**: 简单按每秒分割文本
- **自动模式**: 根据文本长度智能分配显示时间

### 字幕样式

- **默认**: 24号字体，适合大部分场景
- **大字体**: 32号字体，适合高分辨率视频
- **小字体**: 18号字体，适合字幕密集的内容

### 🎙️ 语音合成选项 ⭐ **新功能**

#### 可选语音类型
- **晓晓**: 温柔女声，适合温馨内容（推荐）
- **云希**: 活泼男声，适合动态内容
- **小艺**: 知性女声，适合专业内容
- **云健**: 稳重男声，适合教学内容

#### 语音引擎支持
- **Edge-TTS**: 微软高质量语音引擎（推荐）
- **pyttsx3**: 本地语音合成库
- **系统TTS**: 系统默认语音引擎（备用）

#### 音频处理特性
- **智能语速**: 根据字幕时长自动调整语速
- **音频混合**: 语音与原视频音频平衡混合
- **质量优化**: 44.1kHz采样率，保证音质

### 开始时间设置

- 支持精确到小数点，如 `30.5` 表示30.5秒
- 默认从0秒开始，即视频开始就显示字幕
- 可以设置延迟开始，如从第10秒开始显示字幕

## 📂 文件管理

### 输入文件支持格式

- **视频格式**: .mp4, .avi, .mkv, .mov, .wmv, .flv, .webm
- **文案格式**: .txt, .md, .docx
- **字幕格式**: .srt

### 输出文件规则

- **SRT文件**: 保存在 `srt/` 目录，文件名格式 `subtitle_generated_时间戳.srt`
- **音频文件**: 保存在 `audio/` 目录，包含分段和合并后的语音文件 ⭐ **新增**
- **视频文件**: 保存在 `output/` 目录（如存在）或原视频目录，文件名包含时间戳

### 文件命名规则

所有输出文件都会自动添加时间戳，避免文件覆盖：
- SRT文件: `subtitle_generated_1234567890.srt`
- 视频文件: `原文件名_with_subtitles_20250806_123456.mp4`

## 🛠️ 技术规格

### 系统要求

- **Python**: 2.7.18
- **FFmpeg**: 需要安装并配置到系统PATH
- **操作系统**: Windows/Linux/macOS
- **语音合成依赖**: edge-tts 或 pyttsx3（可选，用于更好的语音效果） ⭐ **新增**

### 核心依赖

- **FFmpeg**: 用于视频处理和字幕嵌入
- **Python标准库**: os, sys, time, re, codecs等

### 字符编码

- 统一使用UTF-8编码处理中文字符
- 兼容Python 2.7的Unicode处理机制
- 支持中英文混合内容

## 🔧 高级功能

### 批量处理

- 支持连续处理多个文件
- 每次处理完成后询问是否继续
- 支持Ctrl+C中断并选择继续或退出
- 处理出错时可选择跳过继续处理其他文件

### 智能文本分割

- 识别中英文标点符号
- 按语义边界分割长文本
- 避免在句子中间断开
- 支持自定义分割策略

### 错误处理

- 完善的异常捕获和处理
- 友好的错误提示信息
- 支持从错误中恢复继续处理
- 详细的调试信息输出

## 📋 使用示例

### 示例1：为产品介绍视频添加字幕和语音

```bash
python subtitle_cli.py
# 选择: 1 (添加字幕到视频)
# 视频路径: D:\Videos\product_demo.mp4
# 字幕来源: 1 (文案文档)
# 文档路径: D:\Documents\product_script.txt
# 分割模式: 1 (智能分割)
# 开始时间: 0 (默认)
# 字幕样式: 1 (默认)
# 语音合成: Y (启用)
# 语音类型: 3 (小艺-知性女声，适合产品介绍)
# 确认处理: Y
```

### 示例2：为教学视频添加解说

```bash
python subtitle_cli.py
# 选择: 1 (添加字幕到视频)
# 视频路径: D:\Education\tutorial.mp4
# 字幕来源: 1 (文案文档)
# 文档路径: D:\Scripts\tutorial_narration.txt
# 分割模式: 1 (智能分割)
# 开始时间: 2 (从第2秒开始)
# 字幕样式: 2 (大字体)
# 语音合成: Y (启用)
# 语音类型: 4 (云健-稳重男声，适合教学内容)
# 确认处理: Y
```

## 🚨 注意事项

1. **FFmpeg配置**: 确保FFmpeg已正确安装并添加到系统PATH
2. **文件路径**: 建议使用绝对路径，避免中文路径可能的编码问题
3. **视频格式**: 推荐使用MP4格式，兼容性最好
4. **文案格式**: 文案文件建议使用UTF-8编码保存
5. **磁盘空间**: 确保有足够空间存储生成的视频文件和音频文件
6. **处理时间**: 视频处理时间取决于视频长度、分辨率和是否启用语音合成
7. **语音合成**: 首次使用可能需要安装TTS依赖，程序会自动提示安装 ⭐ **新增**
8. **网络连接**: Edge-TTS需要网络连接，离线环境可使用系统TTS ⭐ **新增**

## 🐛 常见问题

### Q: 提示"FFmpeg未找到"
A: 请确保FFmpeg已安装并添加到系统PATH环境变量

### Q: 中文字幕显示乱码
A: 确保文案文件使用UTF-8编码保存

### Q: 视频处理失败
A: 检查视频格式是否支持，建议使用MP4格式

### Q: 字幕时间不准确
A: 可以调整分割模式或手动设置开始时间

### Q: 语音合成失败或音质不好
A: 
- 检查网络连接（Edge-TTS需要网络）
- 尝试安装推荐的TTS依赖：`pip install edge-tts`
- 如果网络不畅，可以选择系统TTS引擎

### Q: 生成的视频没有声音或声音不平衡
A: 
- 检查原视频是否有音轨
- 语音音量可能过低，程序会自动调整到0.8倍音量与原音频混合
- 确保FFmpeg支持音频处理功能

## 📞 技术支持

如果遇到问题或需要帮助，请检查：

1. **环境配置**: Python 2.7.18 + FFmpeg
2. **文件格式**: 确保输入文件格式正确
3. **权限问题**: 确保有读写文件的权限
4. **路径问题**: 使用正确的文件路径

## 🔄 更新日志

### v3.0 (2025-08-06) ⭐ **最新版本**
- ✅ 新增语音合成功能
- ✅ 支持4种中文语音选择
- ✅ 多语音引擎支持 (Edge-TTS/pyttsx3/系统TTS)
- ✅ 智能音频混合和语速调整
- ✅ 增强用户界面和选项配置
- ✅ 完善语音文件管理

### v2.0 (之前版本)
- ✅ 添加批量处理功能
- ✅ 优化用户交互体验
- ✅ 完善错误处理机制
- ✅ 支持自定义开始时间
- ✅ 改进文件管理策略

### v1.0 
- ✅ 基础字幕生成功能
- ✅ 视频字幕嵌入功能
- ✅ 智能文本分割算法
- ✅ 多种字幕样式支持

---

**🎯 提示**: 建议先用小视频文件和demo_script.txt测试新的语音合成功能，熟悉操作流程后再处理重要文件。
